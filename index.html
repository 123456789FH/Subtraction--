<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªÙ‚Ø¯ÙŠØ± Ù†ÙˆØ§ØªØ¬ Ø§Ù„Ø·Ø±Ø­ (Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap');
    *{font-family:"Tajawal",system-ui,sans-serif}
    .card{box-shadow:0 18px 60px rgba(15,23,42,.12)}
    .btn{border-radius:18px;font-weight:800;padding:14px 18px}
    .chip{border-radius:999px;padding:6px 12px;font-weight:800;font-size:13px}
    .digit-box{border-width:4px;border-radius:18px;min-width:92px;min-height:84px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:42px;background:#fff}
    .choice{border-radius:18px;border-width:2px;padding:14px 14px;font-weight:800;cursor:pointer;user-select:none}
    .choice:hover{transform:translateY(-1px)}
    .shake{animation:shake .35s ease-in-out}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(6px)}50%{transform:translateX(-6px)}75%{transform:translateX(4px)}}
    .pop{animation:pop .35s ease-in-out}
    @keyframes pop{0%{transform:scale(.98)}60%{transform:scale(1.04)}100%{transform:scale(1)}}
    @media(max-width:640px){
      .digit-box{min-width:82px;min-height:74px;font-size:38px}
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-amber-50 via-white to-purple-50">
  <div class="max-w-5xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white/90 backdrop-blur rounded-3xl card p-6 border border-amber-100">
      <div class="text-center">
        <div class="text-2xl md:text-3xl font-extrabold text-slate-800">ØªÙÙ‚Ù’Ø¯ÙÙŠØ±Ù Ù†ÙÙˆÙØ§ØªÙØ¬Ù Ø§Ù„Ø·Ù‘ÙØ±Ù’Ø­</div>

        <div class="mt-2 inline-block rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3">
          <div class="font-extrabold text-emerald-800">ÙÙÙƒÙ’Ø±ÙØ©Ù Ø§Ù„Ø¯Ù‘ÙØ±Ù’Ø³Ù</div>
          <div class="text-slate-700 font-bold mt-1">Ø£ÙÙ‚ÙØ¯Ù‘ÙØ±Ù Ù†Ø§ØªÙØ¬Ù Ø§Ù„Ø·Ù‘ÙØ±Ù’Ø­Ù Ù…ÙØ³Ù’ØªÙØ¹Ù’Ù…ÙÙ„Ù‹Ø§ Ø§Ù„ØªÙ‘ÙÙ‚Ù’Ø±ÙÙŠØ¨Ù Ø£Ùˆ Ø§Ù„Ø£ÙØ¹Ù’Ø¯ÙØ§Ø¯Ù Ø§Ù„Ù…ÙØªÙÙ†ÙØ§ØºÙÙ…ÙØ©.</div>
        </div>

        <div class="mt-2 text-slate-600">
          Ù„Ø§ Ø£Ø­ØªØ§Ø¬ Ø¬ÙˆØ§Ø¨Ù‹Ø§ Ø¯Ù‚ÙŠÙ‚Ù‹Ø§ØŒ Ø¨Ù„ Ø¬ÙˆØ§Ø¨Ù‹Ø§ Ù‚Ø±ÙŠØ¨Ù‹Ø§ ÙŠØ³Ø§Ø¹Ø¯Ù†ÙŠ Ø¹Ù„Ù‰ ÙØ­Øµ Ø§Ù„Ù…Ø¹Ù‚ÙˆÙ„ÙŠØ© Ø¨Ø³Ø±Ø¹Ø©.
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-2 justify-center">
        <button id="tab-learn" class="btn bg-pink-600 text-white">ØªØ¹Ù„Ù…</button>
        <button id="tab-examples" class="btn bg-white text-slate-700 border-2 border-pink-200">Ø£Ù…Ø«Ù„Ø© Ù…Ø­Ù„ÙˆÙ„Ø©</button>
        <button id="tab-practice" class="btn bg-white text-slate-700 border-2 border-pink-200">ØªØ¯Ø±Ø¨</button>
      </div>
    </div>

    <div class="mt-6">
      <!-- Learn -->
      <section id="section-learn" class="bg-white rounded-3xl card p-6 border border-amber-100">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="rounded-2xl p-5 bg-pink-50 border border-pink-100">
            <div class="font-extrabold text-lg text-slate-800 mb-2">Ù¡) Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ (Ù„Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©)</div>
            <div class="text-slate-700 leading-7">
              <ul class="list-decimal pr-6">
                <li>Ø£Ù‚Ø±Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ù„Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©.</li>
                <li>Ø£Ø·Ø±Ø­ Ø§Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨.</li>
                <li>Ø£Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠØ± Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù†Ø§ØªØ¬.</li>
              </ul>
              <div class="mt-3 flex flex-wrap gap-2">
                <span class="chip bg-white border border-pink-200 text-slate-700">ØªÙ‚Ø±ÙŠØ¨</span>
                <span class="chip bg-white border border-pink-200 text-slate-700">Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©</span>
                <span class="chip bg-white border border-pink-200 text-slate-700">ØªÙ‚Ø¯ÙŠØ±</span>
              </div>
            </div>
          </div>

          <div class="rounded-2xl p-5 bg-purple-50 border border-purple-100">
            <div class="font-extrabold text-lg text-slate-800 mb-2">Ù¢) Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©</div>
            <div class="text-slate-700 leading-7">
              Ø£Ø®ØªØ§Ø± Ø£Ø¹Ø¯Ø§Ø¯Ù‹Ø§ Ù‚Ø±ÙŠØ¨Ø© ØªØ¬Ø¹Ù„ Ø§Ù„Ø·Ø±Ø­ Ø£Ø³Ù‡Ù„.
              Ù…Ø«Ø§Ù„: Ù§Ù£ âˆ’ Ù¢Ù¨ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ù§Ù  âˆ’ Ù£Ù .
              <div class="mt-3 flex flex-wrap gap-2">
                <span class="chip bg-white border border-purple-200 text-slate-700">Ù…ØªÙ†Ø§ØºÙ…Ø©</span>
                <span class="chip bg-white border border-purple-200 text-slate-700">Ù‚Ø±ÙŠØ¨Ø©</span>
                <span class="chip bg-white border border-purple-200 text-slate-700">Ø£Ø³Ù‡Ù„</span>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-5 rounded-2xl p-5 bg-slate-50 border border-slate-200">
          <div class="font-extrabold text-slate-800 mb-2">Ù…ØªÙ‰ Ø£Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ØŸ âœ…</div>
          <ul class="list-disc pr-6 text-slate-700 leading-7">
            <li>Ù„Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© <b>Ù…Ø¹Ù‚ÙˆÙ„Ø©</b>.</li>
            <li>Ø¹Ù†Ø¯Ù…Ø§ Ø£Ø±ÙŠØ¯ Ø¬ÙˆØ§Ø¨Ù‹Ø§ Ø³Ø±ÙŠØ¹Ù‹Ø§ Ù‚Ø±ÙŠØ¨Ù‹Ø§ Ù…Ù† Ø§Ù„ØµØ­ÙŠØ­.</li>
            <li>Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù„Ø£ØªÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø§ØªØ¬.</li>
          </ul>
        </div>
      </section>

      <!-- Examples -->
      <section id="section-examples" class="hidden bg-white rounded-3xl card p-6 border border-amber-100">
        <div class="flex items-center justify-between flex-wrap gap-2 mb-4">
          <div class="font-extrabold text-xl text-slate-800">Ø£Ù…Ø«Ù„Ø© Ù…Ø­Ù„ÙˆÙ„Ø©</div>
          <div class="text-sm text-slate-500">Ø§Ø¶ØºØ·ÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±Ø­</div>
        </div>
        <div id="examplesList" class="grid md:grid-cols-2 gap-4"></div>
      </section>

      <!-- Practice -->
      <section id="section-practice" class="hidden bg-white rounded-3xl card p-6 border border-amber-100">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="font-extrabold text-xl text-slate-800">ØªØ¯Ø±Ø¨: Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØµØ­ÙŠØ­</div>
            <div class="text-slate-600">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø«Ù… Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ø·Ø±Ø­.</div>
          </div>
          <div class="rounded-2xl bg-slate-50 border border-slate-200 px-4 py-3">
            <div class="font-bold text-slate-700">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
            <div class="text-slate-700">â­ <span id="score">Ù </span> / <span id="total">Ù </span></div>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-3 items-center justify-center">
          <label class="font-bold text-slate-700">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©:</label>
          <select id="method" class="btn bg-white border-2 border-slate-200 text-slate-700">
            <option value="round10">Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©</option>
            <option value="harmonic">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©</option>
          </select>

          <label class="font-bold text-slate-700">Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
          <select id="level" class="btn bg-white border-2 border-slate-200 text-slate-700">
            <option value="2d">Ø¹Ø¯Ø¯ÙŠÙ† Ù…Ù† Ø±Ù‚Ù…ÙŠÙ†</option>
            <option value="3d">Ø¹Ø¯Ø¯ÙŠÙ† Ù…Ù† Ù£ Ø£Ø±Ù‚Ø§Ù…</option>
          </select>

          <button id="btnNew" class="btn bg-purple-600 text-white">Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
          <button id="btnShow" class="btn bg-white border-2 border-purple-200 text-slate-700">Ø£Ø¸Ù‡Ø± Ø§Ù„Ø´Ø±Ø­</button>
        </div>

        <div class="mt-6 grid lg:grid-cols-2 gap-6 items-start">
          <!-- Problem -->
          <div class="rounded-3xl border border-pink-100 bg-gradient-to-b from-white to-pink-50 p-5">
            <div class="flex items-center justify-between mb-3">
              <div class="font-extrabold text-slate-800">Ø§Ù„Ù…Ø³Ø£Ù„Ø©</div>
              <div id="badge" class="chip bg-white border border-pink-200 text-slate-700">â€”</div>
            </div>

            <div id="problemArea" class="flex flex-col items-center gap-4"></div>

            <div class="mt-4">
              <div class="font-extrabold text-slate-800 text-center mb-2">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØµØ­ÙŠØ­:</div>
              <div id="choices" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
            </div>
          </div>

          <!-- Feedback -->
          <div class="rounded-3xl border border-slate-200 bg-white p-5">
            <div class="font-extrabold text-slate-800 mb-2">Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø´Ø±Ø­</div>
            <div id="feedback" class="text-slate-700 leading-7">
              Ø§Ø®ØªØ§Ø±ÙŠ Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„ÙŠØªØ­Ù‚Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¥Ø¬Ø§Ø¨ØªÙƒ.
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-slate-600">
      <div class="bg-white/80 inline-block px-4 py-3 rounded-2xl border border-slate-200">
        <span class="font-bold">Ø£/ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ</span> â€¢ Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€¢ Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ
      </div>
    </div>
  </div>

  <script>
    // Arabic digits
    const ar = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
    const toArabic = (n) => {
      if (!Number.isFinite(n)) return '';
      return String(Math.trunc(n)).split('').map(ch=>{
        if (ch==='-') return 'âˆ’';
        const d = ch.charCodeAt(0)-48;
        return (d>=0 && d<=9) ? ar[d] : ch;
      }).join('');
    };

    // Tabs
    const tabs = [
      {btn:'tab-learn', sec:'section-learn'},
      {btn:'tab-examples', sec:'section-examples'},
      {btn:'tab-practice', sec:'section-practice'}
    ];
    function setTab(activeBtnId){
      tabs.forEach(t=>{
        const b=document.getElementById(t.btn);
        const s=document.getElementById(t.sec);
        const active = t.btn===activeBtnId;
        s.classList.toggle('hidden', !active);
        b.className = active ? 'btn bg-pink-600 text-white' : 'btn bg-white text-slate-700 border-2 border-pink-200';
      });
    }
    document.getElementById('tab-learn').onclick=()=>setTab('tab-learn');
    document.getElementById('tab-examples').onclick=()=>setTab('tab-examples');
    document.getElementById('tab-practice').onclick=()=>setTab('tab-practice');

    // Helpers
    const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
    const round10=(n)=> {
      const ones = n%10;
      const base = n-ones;
      return ones>=5 ? base+10 : base;
    };

    function genProblem(level){
      let a,b;
      if (level==='2d'){
        a = randInt(20, 99);
        b = randInt(10, 89);
      } else {
        a = randInt(120, 999);
        b = randInt(100, 899);
      }
      if (b>a) [a,b]=[b,a];
      if (level==='3d' && (a-b) < 30){
        b = Math.max(0, a - randInt(30, 250));
      }
      return {a,b, exact: a-b};
    }

    function harmonicEstimate(a,b){
      const a10 = round10(a);
      const b10 = round10(b);
      return {aH:a10, bH:b10, est:a10-b10};
    }

    function explain(q, method){
      if (method==='round10'){
        const arA = round10(q.a), arB = round10(q.b), est = arA - arB;
        return `
          <div class="text-slate-700 leading-8">
            <div class="font-extrabold text-slate-800 mb-2">Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©</div>
            <div>Ù†Ù‚Ø±Ù‘Ø¨:</div>
            <div class="mt-1">â€¢ ${toArabic(q.a)} â†’ <b class="text-purple-700">${toArabic(arA)}</b></div>
            <div>â€¢ ${toArabic(q.b)} â†’ <b class="text-purple-700">${toArabic(arB)}</b></div>
            <div class="mt-2">Ø«Ù… Ù†Ø·Ø±Ø­:</div>
            <div dir="rtl"><b>${toArabic(arA)} âˆ’ ${toArabic(arB)} = ${toArabic(est)}</b></div>
            <div class="mt-2 text-slate-600">Ø¥Ø°Ù† Ø§Ù„ØªÙ‚Ø¯ÙŠØ± â‰ˆ <b>${toArabic(est)}</b></div>
          </div>
        `;
      } else {
        const h = harmonicEstimate(q.a,q.b);
        return `
          <div class="text-slate-700 leading-8">
            <div class="font-extrabold text-slate-800 mb-2">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©</div>
            <div>Ù†Ø®ØªØ§Ø± Ø£Ø¹Ø¯Ø§Ø¯Ù‹Ø§ Ù‚Ø±ÙŠØ¨Ø© ØªØ³Ù‡Ù‘Ù„ Ø§Ù„Ø·Ø±Ø­:</div>
            <div class="mt-1">â€¢ ${toArabic(q.a)} â‰ˆ <b class="text-purple-700">${toArabic(h.aH)}</b></div>
            <div>â€¢ ${toArabic(q.b)} â‰ˆ <b class="text-purple-700">${toArabic(h.bH)}</b></div>
            <div class="mt-2">Ø«Ù… Ù†Ø·Ø±Ø­ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©:</div>
            <div dir="rtl"><b>${toArabic(h.aH)} âˆ’ ${toArabic(h.bH)} = ${toArabic(h.est)}</b></div>
            <div class="mt-2 text-slate-600">Ø¥Ø°Ù† Ø§Ù„ØªÙ‚Ø¯ÙŠØ± â‰ˆ <b>${toArabic(h.est)}</b></div>
          </div>
        `;
      }
    }

    const examples = [
      {
        title:'Ù…Ø«Ø§Ù„ Ù¡ (ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©)',
        a: 73, b: 28,
        render: () => {
          const arA=round10(73), arB=round10(28), est=arA-arB;
          return `
            <div class="text-slate-700 leading-8">
              <div><b>Ø§Ù„Ù…Ø³Ø£Ù„Ø©:</b> ${toArabic(73)} âˆ’ ${toArabic(28)}</div>
              <div class="mt-2"><b>Ù†Ù‚Ø±Ù‘Ø¨:</b> ${toArabic(73)} â†’ ${toArabic(arA)} ØŒ ${toArabic(28)} â†’ ${toArabic(arB)}</div>
              <div><b>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:</b> <span dir="rtl"><b class="text-purple-700">${toArabic(arA)} âˆ’ ${toArabic(arB)} = ${toArabic(est)}</b></span></div>
            </div>`;
        }
      },
      {
        title:'Ù…Ø«Ø§Ù„ Ù¢ (Ø£Ø¹Ø¯Ø§Ø¯ Ù…ØªÙ†Ø§ØºÙ…Ø©)',
        a: 154, b: 69,
        render: () => {
          const h=harmonicEstimate(154,69);
          return `
            <div class="text-slate-700 leading-8">
              <div><b>Ø§Ù„Ù…Ø³Ø£Ù„Ø©:</b> ${toArabic(154)} âˆ’ ${toArabic(69)}</div>
              <div class="mt-2"><b>Ù†Ø®ØªØ§Ø± Ø£Ø¹Ø¯Ø§Ø¯Ù‹Ø§ Ù‚Ø±ÙŠØ¨Ø©:</b> ${toArabic(154)} â‰ˆ ${toArabic(h.aH)} ØŒ ${toArabic(69)} â‰ˆ ${toArabic(h.bH)}</div>
              <div><b>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:</b> <span dir="rtl"><b class="text-purple-700">${toArabic(h.aH)} âˆ’ ${toArabic(h.bH)} = ${toArabic(h.est)}</b></span></div>
            </div>`;
        }
      }
    ];

    function renderExamples(){
      const container = document.getElementById('examplesList');
      container.innerHTML='';
      examples.forEach((ex, idx)=>{
        const el=document.createElement('div');
        el.className='rounded-3xl border border-slate-200 bg-slate-50 p-5 cursor-pointer hover:shadow-lg transition';
        el.innerHTML=`
          <div class="font-extrabold text-slate-800 mb-2">${ex.title}</div>
          <div class="text-slate-700">${toArabic(ex.a)} âˆ’ ${toArabic(ex.b)}</div>
          <div id="ex-${idx}" class="hidden mt-4 rounded-2xl bg-white border border-slate-200 p-4"></div>
          <div class="mt-3 text-sm text-pink-600 font-bold">Ø§Ø¶ØºØ·ÙŠ Ù„Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±Ø­</div>
        `;
        el.onclick=()=>{
          const box=document.getElementById(`ex-${idx}`);
          const open=!box.classList.contains('hidden');
          if(open){box.classList.add('hidden'); box.innerHTML='';}
          else{box.classList.remove('hidden'); box.innerHTML=ex.render();}
        };
        container.appendChild(el);
      });
    }
    renderExamples();

    let state = { q:null, method:'round10', level:'2d', score:0, total:0, locked:false, correct:0 };

    const scoreEl=document.getElementById('score');
    const totalEl=document.getElementById('total');
    const feedbackEl=document.getElementById('feedback');

    function animateFeedback(kind){
      feedbackEl.classList.remove('shake','pop');
      void feedbackEl.offsetWidth;
      feedbackEl.classList.add(kind==='good'?'pop':'shake');
    }
    function setFeedback(html, kind){ feedbackEl.innerHTML=html; animateFeedback(kind); }

    function buildChoices(correct){
      const d1 = correct + randInt(20, 60) * (Math.random()<0.5 ? 1 : -1);
      const d2 = correct + randInt(40, 120) * (Math.random()<0.5 ? 1 : -1);
      const pool = [correct, Math.max(0,d1), Math.max(0,d2)];
      const uniq = [...new Set(pool.map(x=>Math.max(0,Math.trunc(x))))];
      while(uniq.length<3){ uniq.push(Math.max(0, correct + randInt(10,90))); }
      for(let i=uniq.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [uniq[i],uniq[j]]=[uniq[j],uniq[i]];
      }
      return uniq.slice(0,3);
    }

    function renderProblem(){
      const q=state.q;
      document.getElementById('badge').textContent =
        (state.method==='round10' ? 'ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©' : 'Ø£Ø¹Ø¯Ø§Ø¯ Ù…ØªÙ†Ø§ØºÙ…Ø©') + ' â€¢ ' + (state.level==='2d'?'Ø±Ù‚Ù…ÙŠÙ†':'Ù£ Ø£Ø±Ù‚Ø§Ù…');

      const problemArea=document.getElementById('problemArea');
      problemArea.innerHTML=`
        <div class="flex flex-col items-center gap-4">
          <div class="text-slate-700 font-bold">Ù‚Ø¯Ù‘Ø±ÙŠ Ù†Ø§ØªØ¬ Ø§Ù„Ø·Ø±Ø­:</div>
          <div class="flex items-center gap-4" dir="rtl">
            <div class="digit-box border-pink-500 text-slate-800">${toArabic(q.a)}</div>
            <div class="text-6xl font-extrabold text-pink-600">âˆ’</div>
            <div class="digit-box border-pink-500 text-slate-800">${toArabic(q.b)}</div>
          </div>
          <div class="w-full h-1 rounded-full bg-pink-500"></div>
        </div>
      `;

      const correct = (state.method==='round10')
        ? (round10(q.a) - round10(q.b))
        : (harmonicEstimate(q.a,q.b).est);

      state.correct = correct;

      const choices = buildChoices(correct);
      const box=document.getElementById('choices');
      box.innerHTML='';
      choices.forEach(val=>{
        const div=document.createElement('div');
        div.className='choice bg-white border-slate-200 text-slate-800 text-center';
        div.innerHTML = `<div class="text-3xl">${toArabic(val)}</div>`;
        div.onclick=()=>selectChoice(val);
        box.appendChild(div);
      });

      state.locked=false;
      setFeedback('Ø§Ø®ØªØ§Ø±ÙŠ Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª. ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ <b>Ø£Ø¸Ù‡Ø± Ø§Ù„Ø´Ø±Ø­</b> Ù„Ø±Ø¤ÙŠØ© Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ‚Ø¯ÙŠØ±.', 'good');
    }

    function selectChoice(val){
      if (state.locked) return;
      state.locked=true;

      const ok = (val === state.correct);
      state.total += 1;
      if (ok) state.score += 1;

      scoreEl.textContent = toArabic(state.score);
      totalEl.textContent = toArabic(state.total);

      if (ok){
        setFeedback(`
          <div class="font-extrabold text-emerald-700 text-lg">Ø£Ø­Ø³Ù†ØªÙ! ØªÙ‚Ø¯ÙŠØ± ØµØ­ÙŠØ­ ğŸ‰</div>
          <div class="mt-2"><b>Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØµØ­ÙŠØ­:</b> ${toArabic(state.correct)}</div>
          <div class="mt-3">${explain(state.q, state.method)}</div>
        `,'good');
      } else {
        setFeedback(`
          <div class="font-extrabold text-rose-700 text-lg">Ù‚Ø±ÙŠØ¨Ø©.. Ù„ÙƒÙ† Ù„ÙŠØ³Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ğŸ’¡</div>
          <div class="mt-2"><b>Ø§Ø®ØªÙŠØ§Ø±Ùƒ:</b> ${toArabic(val)}</div>
          <div><b>Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØµØ­ÙŠØ­:</b> ${toArabic(state.correct)}</div>
          <div class="mt-3">${explain(state.q, state.method)}</div>
        `,'bad');
      }
    }

    function newQuestion(){
      state.method = document.getElementById('method').value;
      state.level = document.getElementById('level').value;
      state.q = genProblem(state.level);
      renderProblem();
    }

    function showExplain(){
      setFeedback(explain(state.q, state.method), 'good');
    }

    document.getElementById('method').onchange = newQuestion;
    document.getElementById('level').onchange = newQuestion;
    document.getElementById('btnNew').onclick = newQuestion;
    document.getElementById('btnShow').onclick = showExplain;

    scoreEl.textContent = toArabic(0);
    totalEl.textContent = toArabic(0);
    newQuestion();
    setTab('tab-learn');
  </script>
</body>
</html>
